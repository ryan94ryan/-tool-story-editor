<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>é˜¿ç…™åŠ‡æœ¬ç·¨è¼¯å·¥å…·</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.26.0/cytoscape.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'Segoe UI',sans-serif; background:#0d1117; color:#c9d1d9; height:100vh; display:flex; flex-direction:column; overflow:hidden; }

/* â”€â”€ Toolbar â”€â”€ */
#toolbar {
  background:#161b22; border-bottom:1px solid #30363d;
  padding:6px 12px; display:flex; align-items:center; gap:6px; flex-shrink:0;
}
#toolbar h1 { font-size:14px; color:#f85149; margin-right:4px; white-space:nowrap; }
.sep { width:1px; height:22px; background:#30363d; margin:0 3px; }
.btn {
  padding:4px 10px; border:none; border-radius:5px; cursor:pointer;
  font-size:12px; font-weight:500; transition:filter .15s; white-space:nowrap;
}
.btn:hover { filter:brightness(1.2); }
.btn-primary   { background:#1f6feb; color:#fff; }
.btn-secondary { background:#21262d; color:#c9d1d9; border:1px solid #30363d; }
.btn-success   { background:#238636; color:#fff; }
.btn-purple    { background:#6e40c9; color:#fff; }
input[type=file] { display:none; }
#status { margin-left:auto; font-size:11px; color:#8b949e; white-space:nowrap; }

/* â”€â”€ Dropdown â”€â”€ */
.dropdown { position:relative; display:inline-block; }
.dropdown-menu {
  display:none; position:absolute; top:calc(100% + 4px); left:0; z-index:999;
  background:#21262d; border:1px solid #30363d; border-radius:6px;
  min-width:200px; padding:4px 0;
}
.dropdown-menu.open { display:block; }
.dropdown-item { padding:7px 14px; font-size:12px; cursor:pointer; white-space:nowrap; color:#c9d1d9; }
.dropdown-item:hover { background:#30363d; }
.dropdown-item.item-sep { border-top:1px solid #30363d; margin-top:4px; padding-top:9px; }

/* â”€â”€ Main Layout â”€â”€ */
#main { display:flex; flex:1; overflow:hidden; }

/* â”€â”€ Sidebar â”€â”€ */
#sidebar {
  width:170px; flex-shrink:0; background:#161b22; border-right:1px solid #30363d;
  display:flex; flex-direction:column; overflow-y:auto;
}
.sb-section { padding:10px 12px 4px; font-size:10px; color:#484f58; letter-spacing:.06em; text-transform:uppercase; }
.sb-item {
  padding:7px 14px; font-size:12px; cursor:pointer;
  border-left:3px solid transparent; transition:background .12s; user-select:none;
}
.sb-item:hover { background:#1c2330; }
.sb-item.active { background:#1c2330; border-left-color:#1f6feb; color:#79c0ff; }
.sb-badge { float:right; font-size:10px; color:#484f58; }

/* â”€â”€ Content â”€â”€ */
#content { flex:1; display:flex; flex-direction:column; overflow:hidden; position:relative; }

/* Canvas */
#cy-wrap { flex:1; position:relative; user-select:none; }
#cy { width:100%; height:100%; }
#empty-msg {
  position:absolute; inset:0; display:flex; flex-direction:column;
  align-items:center; justify-content:center; gap:12px; pointer-events:none;
}
#empty-msg .big { font-size:48px; }
#empty-msg p { color:#484f58; font-size:13px; text-align:center; line-height:2; }
#legend {
  position:absolute; bottom:12px; left:12px; background:rgba(22,27,34,.92);
  border:1px solid #30363d; border-radius:6px; padding:8px 12px; font-size:11px;
  pointer-events:none;
}
.li { display:flex; align-items:center; gap:7px; margin:3px 0; }
.ld { width:11px; height:11px; border-radius:2px; }

/* â”€â”€ Rubber Band â”€â”€ */
#rubberband {
  position:absolute; pointer-events:none; display:none; z-index:20;
  border:1.5px dashed #388bfd;
  background:rgba(56,139,253,0.07);
}

/* â”€â”€ FAB â”€â”€ */
#fab {
  position:absolute; bottom:54px; right:16px;
  display:flex; flex-direction:column; gap:8px; z-index:10;
}
#fab.hidden { display:none; }
.fab-btn {
  padding:8px 18px; border:none; border-radius:20px; cursor:pointer;
  font-size:12px; font-weight:600; box-shadow:0 2px 10px rgba(0,0,0,.6);
  transition:filter .15s, transform .12s;
}
.fab-btn:hover { filter:brightness(1.2); transform:scale(1.05); }
.fab-group { background:#1f6feb; color:#fff; }
.fab-se    { background:#6e40c9; color:#fff; }

/* Flags Editor */
#flags-wrap { flex:1; overflow-y:auto; padding:20px; display:none; }
#flags-wrap.visible { display:block; }
.flags-title { font-size:14px; color:#79c0ff; margin-bottom:16px; }
.flags-table { width:100%; border-collapse:collapse; max-width:580px; }
.flags-table th { text-align:left; padding:7px 10px; font-size:11px; color:#8b949e; border-bottom:1px solid #30363d; font-weight:500; }
.flags-table td { padding:5px 6px; border-bottom:1px solid #21262d; }
.flags-table tr:hover td { background:#161b22; }
.flag-name { background:transparent; border:none; color:#79c0ff; font-size:12px; font-family:'Courier New',monospace; width:220px; padding:2px 4px; }
.flag-val  { background:transparent; border:none; color:#c9d1d9; font-size:12px; font-family:'Courier New',monospace; width:90px; padding:2px 4px; }
.flag-name:focus, .flag-val:focus { outline:1px solid #388bfd; border-radius:3px; }
.flag-del { background:transparent; border:none; color:#484f58; cursor:pointer; font-size:14px; padding:0 5px; }
.flag-del:hover { color:#f85149; }
.flags-add { display:flex; gap:8px; margin-top:12px; max-width:580px; }
.fadd-input {
  background:#21262d; border:1px solid #30363d; border-radius:4px;
  color:#c9d1d9; padding:5px 10px; font-size:12px; font-family:'Courier New',monospace;
}
.fadd-input:focus { outline:none; border-color:#388bfd; }

/* â”€â”€ Right Panel â”€â”€ */
#panel {
  width:320px; flex-shrink:0; background:#161b22; border-left:1px solid #30363d;
  display:flex; flex-direction:column; overflow:hidden; position:relative;
  min-width:200px; max-width:680px;
}
#panel-resize {
  position:absolute; left:0; top:0; bottom:0; width:5px;
  cursor:col-resize; z-index:5; background:transparent; transition:background .15s;
}
#panel-resize:hover, #panel-resize.dragging { background:#388bfd55; }
#ph { padding:10px 14px; background:#21262d; font-size:12px; font-weight:600; border-bottom:1px solid #30363d; }
#pc { flex:1; padding:12px; overflow-y:auto; }
.empty-panel { color:#484f58; font-size:12px; text-align:center; padding-top:40px; line-height:2; }
.fl { font-size:10px; color:#8b949e; margin-top:10px; margin-bottom:3px; }
.fv { font-size:12px; }
.preview-box {
  background:#0d1117; border:1px solid #30363d; border-radius:4px;
  padding:8px; font-family:'Courier New',monospace; font-size:11px;
  line-height:1.5; white-space:pre-wrap; color:#8b949e; max-height:140px; overflow:auto;
}
#node-editor {
  width:100%; min-height:260px; resize:vertical;
  background:#0d1117; color:#c9d1d9; border:1px solid #30363d; border-radius:4px;
  padding:8px; font-family:'Courier New',monospace; font-size:12px; line-height:1.6;
}
#node-editor:focus { outline:none; border-color:#388bfd; }
#pa { padding:10px 12px; display:flex; gap:8px; border-top:1px solid #30363d; flex-shrink:0; }
.tag { display:inline-block; padding:2px 8px; border-radius:10px; font-size:10px; margin:2px; }
.tg  { background:#0d419d; border:1px solid #388bfd; }
.tb  { background:#5a1e1e; border:1px solid #f85149; }
.ts  { background:#6e40c9; border:1px solid #a371f7; }
.tc  { background:#3d2f00; border:1px solid #e3b341; }

/* â”€â”€ Modal Editor â”€â”€ */
#modal-overlay {
  display:none; position:fixed; inset:0; z-index:1000;
  background:rgba(0,0,0,0.6); backdrop-filter:blur(2px);
}
#modal-overlay.open { display:flex; align-items:center; justify-content:center; }
#modal-box {
  background:#161b22; border:1px solid #30363d; border-radius:8px;
  width:700px; min-width:400px; max-width:90vw;
  height:500px; min-height:300px; max-height:85vh;
  display:flex; flex-direction:column; position:relative;
  box-shadow:0 8px 32px rgba(0,0,0,0.5);
}
#modal-header {
  padding:10px 14px; background:#21262d; border-bottom:1px solid #30363d;
  border-radius:8px 8px 0 0; cursor:move; user-select:none;
  display:flex; align-items:center; gap:10px;
}
#modal-title { flex:1; font-size:13px; font-weight:600; color:#c9d1d9; }
#modal-close {
  background:transparent; border:none; color:#8b949e; font-size:18px;
  cursor:pointer; padding:0 4px; line-height:1;
}
#modal-close:hover { color:#f85149; }
#modal-body { flex:1; padding:12px; overflow:hidden; display:flex; flex-direction:column; position:relative; }
#modal-info { font-size:11px; color:#8b949e; margin-bottom:8px; }
#modal-info .tag { vertical-align:middle; }
#editor-wrap {
  flex:1; position:relative; overflow:hidden; border:1px solid #30363d; border-radius:4px;
  background:#0d1117;
}
#editor-highlight {
  position:absolute; inset:0; padding:8px; overflow:auto;
  font-family:'Courier New',monospace; font-size:14px; line-height:1.6;
  white-space:pre-wrap; word-wrap:break-word; color:transparent;
  pointer-events:none; z-index:1;
}
#editor-highlight .hl-comment { color:#2d6a4f; }
#editor-highlight .hl-cmd { color:#58a6ff; }
#editor-highlight .hl-text { color:#c9d1d9; }
/* Command visibility modes */
#editor-wrap.cmd-dim .hl-cmd { color:#484f58; opacity:0.5; }
#editor-wrap.cmd-hide .hl-cmd { opacity:0; }
.cmd-toggle { display:flex; align-items:center; }
.cmd-btn {
  padding:4px 10px; border:1px solid #30363d; background:#21262d;
  color:#8b949e; font-size:11px; cursor:pointer; transition:all .15s;
}
.cmd-btn:first-of-type { border-radius:4px 0 0 4px; }
.cmd-btn:last-of-type { border-radius:0 4px 4px 0; }
.cmd-btn:not(:first-of-type) { border-left:none; }
.cmd-btn:hover { background:#30363d; }
.cmd-btn.active { background:#238636; border-color:#238636; color:#fff; }
#modal-editor {
  position:absolute; inset:0; padding:8px; resize:none;
  background:transparent; color:transparent; border:none;
  font-family:'Courier New',monospace; font-size:14px; line-height:1.6;
  z-index:2; caret-color:#c9d1d9;
}
#modal-editor:focus { outline:none; }
#modal-footer {
  padding:10px 12px; display:flex; gap:8px; border-top:1px solid #30363d;
  justify-content:flex-end;
}
#modal-resize {
  position:absolute; right:0; bottom:0; width:16px; height:16px;
  cursor:nwse-resize; z-index:10;
}
#modal-resize::after {
  content:''; position:absolute; right:4px; bottom:4px;
  width:8px; height:8px; border-right:2px solid #484f58; border-bottom:2px solid #484f58;
}
</style>
</head>
<body>

<!-- â”€â”€ Toolbar â”€â”€ -->
<div id="toolbar">
  <h1>ğŸ¬ é˜¿ç…™åŠ‡æœ¬ç·¨è¼¯å·¥å…·</h1>
  <button class="btn btn-primary" onclick="triggerImportMaster()">ğŸ“‚ åŒ¯å…¥ä¸»æª”</button>
  <input type="file" id="fi-master" accept=".txt" onchange="onImportMaster(event)">

  <div class="dropdown" id="dd-ind">
    <button class="btn btn-secondary" onclick="toggleDD('dd-ind')">ğŸ“‚ å€‹åˆ¥åŒ¯å…¥ â–¾</button>
    <div class="dropdown-menu" id="dd-ind-menu">
      <div class="dropdown-item" onclick="trigInd('d');closeDD('dd-ind')">åŒ¯å…¥ Dialogueï¼ˆç•¶å‰ç« ç¯€ï¼‰</div>
      <div class="dropdown-item" onclick="trigInd('s');closeDD('dd-ind')">åŒ¯å…¥ Selectionï¼ˆç•¶å‰ç« ç¯€ï¼‰</div>
      <div class="dropdown-item item-sep" onclick="trigInd('ed');closeDD('dd-ind')">åŒ¯å…¥ Extra_Dialogue.txt</div>
      <div class="dropdown-item" onclick="trigInd('es');closeDD('dd-ind')">åŒ¯å…¥ Extra_Selection.txt</div>
      <div class="dropdown-item item-sep" onclick="trigInd('gf');closeDD('dd-ind')">åŒ¯å…¥ GlobalFlags.txt</div>
      <div class="dropdown-item" onclick="trigInd('ef');closeDD('dd-ind')">åŒ¯å…¥ Extra_Flags.txt</div>
    </div>
  </div>
  <input type="file" id="fi-d"  accept=".txt" onchange="onInd('d',event)">
  <input type="file" id="fi-s"  accept=".txt" onchange="onInd('s',event)">
  <input type="file" id="fi-ed" accept=".txt" onchange="onInd('ed',event)">
  <input type="file" id="fi-es" accept=".txt" onchange="onInd('es',event)">
  <input type="file" id="fi-gf" accept=".txt" onchange="onInd('gf',event)">
  <input type="file" id="fi-ef" accept=".txt" onchange="onInd('ef',event)">

  <div class="sep"></div>
  <button class="btn btn-secondary" onclick="doLayout()">ğŸ“ æ’ç‰ˆ</button>
  <button class="btn btn-secondary" onclick="cyFit()">ğŸ” å…¨è¦½</button>
  <div class="sep"></div>
  <button class="btn btn-success" onclick="doSaveMaster()">ğŸ’¾ å„²å­˜ä¸»æª”</button>
  <button class="btn btn-purple"  onclick="doRelease()">ğŸš€ ä¸€éµé‡‹å‡º</button>
  <div class="sep"></div>
  <div class="dropdown" id="dd-cloud">
    <button class="btn btn-secondary" onclick="toggleDD('dd-cloud')" style="background:#0e4429;border-color:#238636;">â˜ é›²ç«¯ â–¾</button>
    <div class="dropdown-menu" id="dd-cloud-menu">
      <div class="dropdown-item" onclick="showCloudSettings();closeDD('dd-cloud')">âš™ è¨­å®š API Key</div>
      <div class="dropdown-item item-sep" onclick="cloudSave();closeDD('dd-cloud')">â˜ é›²ç«¯å­˜æª”</div>
      <div class="dropdown-item" onclick="cloudLoad();closeDD('dd-cloud')">â˜ é›²ç«¯è®€å–</div>
    </div>
  </div>
  <a href="help.html" target="_blank" class="btn btn-secondary" style="text-decoration:none;">â“ èªªæ˜</a>
  <span id="status">è«‹åŒ¯å…¥ä¸»æª”ï¼Œæˆ–ä½¿ç”¨ã€Œå€‹åˆ¥åŒ¯å…¥ã€è¼‰å…¥å„ç« ç¯€</span>
</div>

<!-- â”€â”€ Main â”€â”€ -->
<div id="main">
  <div id="sidebar">
    <div class="sb-section">ä¸»ç·š</div>
    <div class="sb-item" id="sb-Chapter_0" onclick="setActive('Chapter_0')">ğŸ“– ç¬¬é›¶ç« <span class="sb-badge" id="badge-Chapter_0"></span></div>
    <div class="sb-item" id="sb-Chapter_1" onclick="setActive('Chapter_1')">ğŸ“– ç¬¬ä¸€ç« <span class="sb-badge" id="badge-Chapter_1"></span></div>
    <div class="sb-item" id="sb-Chapter_2" onclick="setActive('Chapter_2')">ğŸ“– ç¬¬äºŒç« <span class="sb-badge" id="badge-Chapter_2"></span></div>
    <div class="sb-item" id="sb-Chapter_3" onclick="setActive('Chapter_3')">ğŸ“– ç¬¬ä¸‰ç« <span class="sb-badge" id="badge-Chapter_3"></span></div>
    <div class="sb-item" id="sb-Chapter_4" onclick="setActive('Chapter_4')">ğŸ“– ç¬¬å››ç« <span class="sb-badge" id="badge-Chapter_4"></span></div>
    <div class="sb-section">æ”¯ç·š</div>
    <div class="sb-item" id="sb-Extra"       onclick="setActive('Extra')">ğŸ—º æ”¯ç·šåŠ‡æƒ…<span class="sb-badge" id="badge-Extra"></span></div>
    <div class="sb-item" id="sb-extra_flags" onclick="setActive('extra_flags')">ğŸš© æ”¯ç·šæ——æ¨™</div>
    <div class="sb-section">æ——æ¨™</div>
    <div class="sb-item" id="sb-flags" onclick="setActive('flags')">ğŸ³ å…¨åŸŸæ——æ¨™</div>
  </div>

  <div id="content">
    <div id="cy-wrap">
      <div id="cy"></div>
      <div id="empty-msg">
        <div class="big">ğŸ—º</div>
        <p>é»æ“Šå·¦å´ç« ç¯€é¡¯ç¤ºæµç¨‹åœ–<br>æˆ–å…ˆåŒ¯å…¥ä¸»æª” / å€‹åˆ¥æª”æ¡ˆ</p>
      </div>
      <div id="legend">
        <div class="li"><div class="ld" style="background:#1158c7"></div>å°è©± Group</div>
        <div class="li"><div class="ld" style="background:#8b1a1a"></div>æˆ°é¬¥ Group</div>
        <div class="li"><div class="ld" style="background:#7d5a00"></div>å ´æ™¯è·³è½‰</div>
        <div class="li"><div class="ld" style="background:#5a2da6"></div>é¸é …åˆ†æ”¯ SE</div>
        <div class="li"><div class="ld" style="background:#4a3000"></div>æ¢ä»¶åˆ†æ”¯ IF</div>
      </div>
      <!-- rubber band overlay -->
      <div id="rubberband"></div>
      <!-- FAB -->
      <div id="fab" class="hidden">
        <button class="fab-btn fab-se"    onclick="addNewSE()">ï¼‹ SE</button>
        <button class="fab-btn fab-group" onclick="addNewGroup()">ï¼‹ Group</button>
      </div>
    </div>
    <div id="flags-wrap"></div>
  </div>

  <div id="panel">
    <div id="panel-resize"></div>
    <div id="ph">ç¯€é»å±¬æ€§</div>
    <div id="pc"><div class="empty-panel">é»é¸ç¯€é»<br>ä»¥æŸ¥çœ‹ä¸¦ç·¨è¼¯å…§å®¹</div></div>
    <div id="pa" style="display:none">
      <button class="btn btn-success"   style="flex:1" onclick="openModal()">ğŸ“ é–‹å•Ÿç·¨è¼¯å™¨</button>
      <button class="btn btn-secondary" style="flex:1" onclick="deselNode()">âœ• å–æ¶ˆ</button>
    </div>
  </div>
</div>

<!-- Modal Editor -->
<div id="modal-overlay" onclick="onOverlayClick(event)">
  <div id="modal-box">
    <div id="modal-header">
      <span id="modal-title">ç·¨è¼¯ç¯€é»</span>
      <button id="modal-close" onclick="closeModal()">âœ•</button>
    </div>
    <div id="modal-body">
      <div id="modal-info"></div>
      <div id="editor-wrap">
        <div id="editor-highlight"></div>
        <textarea id="modal-editor" spellcheck="false" oninput="syncHighlight()" onscroll="syncScroll()"></textarea>
      </div>
    </div>
    <div id="modal-footer">
      <div class="cmd-toggle">
        <span style="font-size:11px;color:#8b949e;margin-right:6px;">æŒ‡ä»¤ï¼š</span>
        <button class="cmd-btn active" onclick="setCmdMode('normal')">é¡¯ç¤º</button>
        <button class="cmd-btn" onclick="setCmdMode('dim')">æ·¡åŒ–</button>
        <button class="cmd-btn" onclick="setCmdMode('hide')">éš±è—</button>
      </div>
      <div style="flex:1"></div>
      <button class="btn btn-success" onclick="saveModal()">âœ“ å„²å­˜</button>
      <button class="btn btn-secondary" onclick="closeModal()">âœ• å–æ¶ˆ</button>
    </div>
    <div id="modal-resize"></div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Constants
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CH_KEYS = ['Chapter_0','Chapter_1','Chapter_2','Chapter_3','Chapter_4'];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  State
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const S = {
  chapters: Object.fromEntries(
    [...CH_KEYS, 'Extra'].map(k => [k, { dialogue:{}, selection:{} }])
  ),
  globalFlags: [],
  extraFlags:  [],
  posCache:    {},   // { chapterKey: { nodeId: {x,y} } }
  active: null,
  cy: null,
  sel: null,
  masterFile: 'TianmoRebirth_Master.txt'
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Position Cache Helpers
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function syncPosCache() {
  if (!S.cy || !S.active || S.active==='flags' || S.active==='extra_flags') return;
  const pos = {};
  S.cy.nodes().forEach(n => { pos[n.id()] = { x: n.position('x'), y: n.position('y') }; });
  S.posCache[S.active] = pos;
}

function applyPosToElements(els, key) {
  const saved = S.posCache[key];
  if (!saved) return false;  // no cache â†’ caller should run layout
  // Find a fallback center for new nodes
  const vals = Object.values(saved);
  const cx = vals.length ? vals.reduce((s,p)=>s+p.x,0)/vals.length : 400;
  const cy = vals.length ? vals.reduce((s,p)=>s+p.y,0)/vals.length : 300;
  let hasNew = false;
  els.forEach(el => {
    if (el.group !== 'nodes') return;
    if (saved[el.data.id]) {
      el.position = { x: saved[el.data.id].x, y: saved[el.data.id].y };
    } else {
      // New node: place near center with small random offset
      el.position = { x: cx + (Math.random()-0.5)*120, y: cy + (Math.random()-0.5)*120 };
      hasNew = true;
    }
  });
  return true;  // used cached positions
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Master File â€” Parser
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function parseMasterFile(text) {
  [...CH_KEYS, 'Extra'].forEach(k => { S.chapters[k] = { dialogue:{}, selection:{} }; });
  S.globalFlags = [];  S.extraFlags = [];

  let section='', subsect='', curGroup=null, curSE=null;
  const ch = () => (section && section !== 'flags') ? S.chapters[section] : null;

  for (const raw of text.split(/\r?\n/)) {
    const t = raw.trim();
    if (t==='ã€Flagsã€‘')  { section='flags'; subsect=''; curGroup=null; curSE=null; continue; }
    if (t==='ã€Extraã€‘')  { section='Extra'; subsect=''; curGroup=null; curSE=null; continue; }
    const chM = t.match(/^ã€(Chapter_\d+)ã€‘$/);
    if (chM && S.chapters[chM[1]]) { section=chM[1]; subsect=''; curGroup=null; curSE=null; continue; }
    if (t==='ã€ExtraFlagsã€‘') { subsect='extraflags'; curGroup=null; curSE=null; continue; }
    if (t==='ã€Dialogueã€‘')   { subsect='dialogue';   curGroup=null; curSE=null; continue; }
    if (t==='ã€Selectionã€‘')  { subsect='selection';  curGroup=null; curSE=null; continue; }
    if (t==='ã€é¸æ“‡ã€‘') continue;

    const gM = t.match(/^ã€Group_(\d+)ã€‘$/);
    if (gM && subsect==='dialogue' && ch()) {
      curGroup=+gM[1]; curSE=null;
      if (!ch().dialogue[curGroup]) ch().dialogue[curGroup]={id:curGroup,rawLines:[]};
      continue;
    }
    const seM = t.match(/^ã€SE_(\d+)ã€‘$/);
    if (seM && subsect==='selection' && ch()) {
      curSE=+seM[1]; curGroup=null;
      if (!ch().selection[curSE]) ch().selection[curSE]={id:curSE,rawLines:[]};
      continue;
    }
    if (section==='flags') {
      if (t && !t.startsWith('//')) { const m=t.match(/^([^:]+):(.*)$/); if(m) S.globalFlags.push({name:m[1].trim(),value:m[2].trim()}); }
      continue;
    }
    if (section==='Extra' && subsect==='extraflags') {
      if (t && !t.startsWith('//')) { const m=t.match(/^([^:]+):(.*)$/); if(m) S.extraFlags.push({name:m[1].trim(),value:m[2].trim()}); }
      continue;
    }
    if (subsect==='dialogue' && curGroup!==null && ch()) ch().dialogue[curGroup].rawLines.push(raw);
    else if (subsect==='selection' && curSE!==null && ch()) ch().selection[curSE].rawLines.push(raw);
  }
  Object.values(S.chapters).forEach(c => {
    [c.dialogue,c.selection].forEach(dict => {
      Object.values(dict).forEach(g => {
        while (g.rawLines.length && !g.rawLines[g.rawLines.length-1].trim()) g.rawLines.pop();
      });
    });
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Individual Parsers
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function parseDialogue(text) {
  const groups={};  let cur=null;
  for (const raw of text.split(/\r?\n/)) {
    const t=raw.trim();
    if (t.match(/^ã€GroupSection_\d+ã€‘$/)) continue;
    const m=t.match(/^ã€Group_(\d+)ã€‘$/);
    if (m) { cur=+m[1]; if(!groups[cur]) groups[cur]={id:cur,rawLines:[]}; continue; }
    if (cur!==null) groups[cur].rawLines.push(raw);
  }
  Object.values(groups).forEach(g => { while(g.rawLines.length&&!g.rawLines[g.rawLines.length-1].trim()) g.rawLines.pop(); });
  return groups;
}
function parseSelection(text) {
  const sets={};  let cur=null;
  for (const raw of text.split(/\r?\n/)) {
    const t=raw.trim();
    if (t==='ã€é¸æ“‡ã€‘') continue;
    const m=t.match(/^ã€SE_(\d+)ã€‘$/);
    if (m) { cur=+m[1]; if(!sets[cur]) sets[cur]={id:cur,rawLines:[]}; continue; }
    if (cur!==null) sets[cur].rawLines.push(raw);
  }
  return sets;
}
function parseFlags(text) {
  const result=[];
  for (const raw of text.split(/\r?\n/)) {
    const t=raw.trim();
    if (!t||t.startsWith('//')) continue;
    const m=t.match(/^([^:]+):(.*)$/);
    if (m) result.push({name:m[1].trim(),value:m[2].trim()});
  }
  return result;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Generators
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function generateMasterFile() {
  let out='';
  out+='ã€Flagsã€‘\n'; S.globalFlags.forEach(f=>{out+=`${f.name}:${f.value}\n`;}); out+='\n';
  CH_KEYS.forEach(key=>{
    const c=S.chapters[key]; out+=`ã€${key}ã€‘\n`;
    const dIds=numSort(c.dialogue);
    if (dIds.length) { out+='ã€Dialogueã€‘\n'; dIds.forEach(id=>{out+=`ã€Group_${id}ã€‘\n${c.dialogue[id].rawLines.join('\n')}\n\n`;}); }
    const sIds=numSort(c.selection);
    if (sIds.length) { out+='ã€Selectionã€‘\n'; sIds.forEach(id=>{out+=`ã€SE_${id}ã€‘\n${c.selection[id].rawLines.join('\n')}\n`;}); }
    out+='\n';
  });
  const ex=S.chapters['Extra']; out+='ã€Extraã€‘\n';
  if (S.extraFlags.length) { out+='ã€ExtraFlagsã€‘\n'; S.extraFlags.forEach(f=>{out+=`${f.name}:${f.value}\n`;}); out+='\n'; }
  const exDIds=numSort(ex.dialogue);
  if (exDIds.length) { out+='ã€Dialogueã€‘\n'; exDIds.forEach(id=>{out+=`ã€Group_${id}ã€‘\n${ex.dialogue[id].rawLines.join('\n')}\n\n`;}); }
  const exSIds=numSort(ex.selection);
  if (exSIds.length) { out+='ã€Selectionã€‘\n'; exSIds.forEach(id=>{out+=`ã€SE_${id}ã€‘\n${ex.selection[id].rawLines.join('\n')}\n`;}); }
  return out;
}
function genDialogue(d){ let o=''; numSort(d).forEach(id=>{o+=`ã€Group_${id}ã€‘\n${d[id].rawLines.join('\n')}\n\n`;}); return o.trimEnd()+'\n'; }
function genSelection(s){ let o='ã€é¸æ“‡ã€‘\n'; numSort(s).forEach(id=>{o+=`ã€SE_${id}ã€‘\n${s[id].rawLines.join('\n')}\n`;}); return o; }
function genFlags(f){ return f.map(x=>`${x.name}:${x.value}`).join('\n')+'\n'; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Graph Analysis Helpers
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function edgesFromGroup(rawLines) {
  const jumps=new Set(), sels=new Set(), conds=[];
  let battleId=null, sceneId=null;
  for (const line of rawLines) {
    const t=line.trim();
    const ifm=t.match(/\{IF_([^:]+):G_(\d+):G_(\d+)\}/);
    if (ifm) { conds.push({cond:ifm[1],tG:+ifm[2],fG:+ifm[3]}); continue; }
    const sm=t.match(/\{S_(\d+)\}/);
    if (sm) { sels.add(+sm[1]); continue; }
    for (const gm of t.matchAll(/\{G_(\d+)\}/g)) jumps.add(+gm[1]);
    const bm=t.match(/\{BattleSetting_([^}]+)\}/); if(bm) battleId=bm[1];
    const xm=t.match(/\{GOSCENE_(\d+)\}/);         if(xm) sceneId=+xm[1];
  }
  return {jumps:[...jumps],sels:[...sels],conds,battleId,sceneId};
}
function optionsFromSE(rawLines) {
  const opts=[];
  for (const line of rawLines) {
    const t=line.trim();
    if (!t.startsWith('Buttonset')||t.endsWith('null')) continue;
    const parts=t.split(':'); if(parts.length<3) continue;
    const gm=parts.slice(2).join(':').match(/\{G_(\d+)\}/);
    if (gm) opts.push({label:parts[1].trim(),target:+gm[1]});
  }
  return opts;
}
function groupPreview(rawLines) {
  for (const l of rawLines) { const t=l.trim(); if(t&&!t.startsWith('{')&&!t.startsWith('ã€')&&!t.startsWith('//')) return t.substring(0,38); }
  for (const l of rawLines) { const t=l.trim(); if(t.startsWith('{')) return t.substring(0,38); }
  return 'ï¼ˆç©ºï¼‰';
}
function sePreview(rawLines) {
  return rawLines.map(l=>l.trim()).filter(l=>l.startsWith('Buttonset')&&!l.includes('null'))
    .map(l=>{ const p=l.split(':'); return p.length>=2?p[1].trim():''; })
    .filter(Boolean).slice(0,3).join(' / ').substring(0,44)||'ï¼ˆç©ºï¼‰';
}
function calcNtype(rawLines) {
  const i=edgesFromGroup(rawLines);
  if (i.battleId) return 'battle';
  if (i.sceneId!==null) return 'scene';
  return 'group';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Build Cytoscape Elements
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildElements(key) {
  const c=S.chapters[key]; if(!c) return [];
  const {dialogue,selection}=c;
  const nodes=[], edges=[];
  let ei=0;

  // All Group nodes
  for (const [k,g] of Object.entries(dialogue)) {
    const id=+k;
    nodes.push({group:'nodes', data:{id:`Group_${id}`, label:`Group ${id}\n${groupPreview(g.rawLines)}`, ntype:calcNtype(g.rawLines)}});
  }
  // All SE nodes
  for (const [k,se] of Object.entries(selection)) {
    const id=+k;
    nodes.push({group:'nodes', data:{id:`SE_${id}`, label:`SE ${id}\n${sePreview(se.rawLines)}`, ntype:'se'}});
  }
  // Cond nodes
  for (const [k,g] of Object.entries(dialogue)) {
    const id=+k, info=edgesFromGroup(g.rawLines);
    info.conds.forEach((c,ci)=>{
      nodes.push({group:'nodes', data:{id:`Cond_${id}_${ci}`, label:`IF\n${c.cond}`, ntype:'cond'}});
    });
  }

  const nodeIds=new Set(nodes.map(n=>n.data.id));
  const addEdge=(src,tgt,lbl='')=>{ if(nodeIds.has(tgt)) edges.push({group:'edges',data:{id:`e${ei++}`,source:src,target:tgt,label:lbl}}); };

  // Group edges
  for (const [k,g] of Object.entries(dialogue)) {
    const id=+k, info=edgesFromGroup(g.rawLines);
    for (const t of info.jumps) if(dialogue[t]) addEdge(`Group_${id}`,`Group_${t}`);
    for (const s of info.sels) addEdge(`Group_${id}`,`SE_${s}`,'é¸é …');
    info.conds.forEach((c,ci)=>{
      const cn=`Cond_${id}_${ci}`;
      addEdge(`Group_${id}`,cn);
      if(dialogue[c.tG]) addEdge(cn,`Group_${c.tG}`,'TRUE');
      if(dialogue[c.fG]) addEdge(cn,`Group_${c.fG}`,'FALSE');
    });
  }
  // SE edges
  for (const [k,se] of Object.entries(selection)) {
    const id=+k;
    for (const opt of optionsFromSE(se.rawLines))
      if(dialogue[opt.target]) addEdge(`SE_${id}`,`Group_${opt.target}`,opt.label.substring(0,12));
  }
  return [...nodes,...edges];
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Cytoscape Style
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CY_STYLE = [
  { selector:'node[ntype="group"]', style:{
    'background-color':'#0d2d6e','border-color':'#1f6feb','border-width':2,
    'shape':'roundrectangle','width':170,'height':56,
    'label':'data(label)','color':'#c9d1d9','font-size':10,
    'text-wrap':'wrap','text-max-width':158,'text-valign':'center','text-halign':'center'
  }},
  { selector:'node[ntype="battle"]', style:{
    'background-color':'#4a0d0d','border-color':'#f85149','border-width':2,
    'shape':'roundrectangle','width':170,'height':56,
    'label':'data(label)','color':'#c9d1d9','font-size':10,
    'text-wrap':'wrap','text-max-width':158,'text-valign':'center','text-halign':'center'
  }},
  { selector:'node[ntype="scene"]', style:{
    'background-color':'#3d2e00','border-color':'#e3b341','border-width':2,
    'shape':'roundrectangle','width':170,'height':56,
    'label':'data(label)','color':'#c9d1d9','font-size':10,
    'text-wrap':'wrap','text-max-width':158,'text-valign':'center','text-halign':'center'
  }},
  { selector:'node[ntype="se"]', style:{
    'background-color':'#2d1b69','border-color':'#a371f7','border-width':2,
    'shape':'diamond','width':155,'height':74,
    'label':'data(label)','color':'#c9d1d9','font-size':10,
    'text-wrap':'wrap','text-max-width':132,'text-valign':'center','text-halign':'center'
  }},
  { selector:'node[ntype="cond"]', style:{
    'background-color':'#3d2f00','border-color':'#d4a015','border-width':2,
    'shape':'hexagon','width':120,'height':54,
    'label':'data(label)','color':'#c9d1d9','font-size':10,
    'text-wrap':'wrap','text-max-width':110,'text-valign':'center','text-halign':'center'
  }},
  { selector:'node:selected', style:{'border-color':'#f0883e','border-width':3}},
  { selector:'edge', style:{
    'width':1.5,'line-color':'#30363d','target-arrow-color':'#30363d',
    'target-arrow-shape':'triangle','curve-style':'bezier',
    'label':'data(label)','font-size':9,'color':'#8b949e',
    'text-background-color':'#0d1117','text-background-opacity':0.85,'text-background-padding':2
  }},
  { selector:'edge[label="TRUE"]',  style:{'line-color':'#3fb950','target-arrow-color':'#3fb950'}},
  { selector:'edge[label="FALSE"]', style:{'line-color':'#f85149','target-arrow-color':'#f85149'}},
  { selector:'edge[label="é¸é …"]',  style:{'line-color':'#a371f7','target-arrow-color':'#a371f7','line-style':'dashed'}},
];

// cose layout with stronger anti-overlap
const COSE_LAYOUT = {
  name: 'cose',
  animate: false,
  randomize: true,
  nodeRepulsion: 14000,
  nodeOverlap: 40,
  idealEdgeLength: 160,
  edgeElasticity: 100,
  gravity: 30,
  numIter: 1500,
  coolingFactor: 0.95,
  padding: 70
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Cytoscape Init
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initCy(els, usePreset) {
  if (S.cy) { S.cy.destroy(); S.cy=null; }
  document.getElementById('empty-msg').style.display = els.length?'none':'flex';
  if (!els.length) return;

  const layout = usePreset ? { name:'preset' } : COSE_LAYOUT;

  S.cy = cytoscape({
    container: document.getElementById('cy'),
    elements: els,
    style: CY_STYLE,
    layout,
    // allow multi-node grabbing
    boxSelectionEnabled: false,
    selectionType: 'single'   // we handle multi-select ourselves via rubber band
  });

  S.cy.on('tap','node', e => {
    S.sel = e.target.id();
    renderPanel();
  });
  S.cy.on('tap', e => {
    if (e.target === S.cy) { S.sel=null; S.cy.elements().unselect(); renderPanel(); }
  });
  // Save positions whenever nodes are dragged
  S.cy.on('dragfree','node', syncPosCache);
}

function doLayout() {
  if (!S.cy) return;
  // Clear cache for current chapter so next refresh will re-run layout
  delete S.posCache[S.active];
  S.cy.layout(COSE_LAYOUT).run();
  // Save positions after layout completes (animate:false â†’ synchronous)
  syncPosCache();
}
function cyFit(){ if(S.cy) S.cy.fit(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Refresh Graph (position-aware)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function refreshGraph() {
  if (!S.active||S.active==='flags'||S.active==='extra_flags') return;
  const key=S.active;
  const els=buildElements(key);

  const hasCached = applyPosToElements(els, key);
  initCy(els, hasCached);   // preset if cached, cose otherwise
  syncPosCache();            // write back (captures layout result or preset)
  updateBadges();
}

// Recalculate ONLY edges for current chapter, keeping node positions intact
// Called when edge connections may have changed but layout should not move
function refreshEdgesOnly() {
  if (!S.cy || !S.active || S.active==='flags' || S.active==='extra_flags') return;
  const key=S.active;
  const c=S.chapters[key];

  // Remove all edges and cond nodes, then re-add based on current data
  S.cy.edges().remove();
  S.cy.nodes().filter(n=>n.id().startsWith('Cond_')).remove();

  const {dialogue,selection}=c;
  let ei=0;
  const uid=()=>`er_${ei++}_${Date.now()}`;
  const nodeIds=new Set(S.cy.nodes().map(n=>n.id()));
  const addE=(src,tgt,lbl='')=>{
    if(!nodeIds.has(tgt)) return;
    S.cy.add({group:'edges',data:{id:uid(),source:src,target:tgt,label:lbl}});
  };

  for (const [k,g] of Object.entries(dialogue)) {
    const id=+k, info=edgesFromGroup(g.rawLines);
    // Also update ntype/label in case content changed
    const node=S.cy.getElementById(`Group_${id}`);
    if (node.length) {
      node.data('label',`Group ${id}\n${groupPreview(g.rawLines)}`);
      node.data('ntype',calcNtype(g.rawLines));
    }
    for (const t of info.jumps) if(dialogue[t]) addE(`Group_${id}`,`Group_${t}`);
    for (const s of info.sels) addE(`Group_${id}`,`SE_${s}`,'é¸é …');
    info.conds.forEach((c,ci)=>{
      const cn=`Cond_${id}_${ci}`;
      if (!S.cy.getElementById(cn).length) {
        const srcNode=S.cy.getElementById(`Group_${id}`);
        const px=srcNode.length?srcNode.position('x')+100:400;
        const py=srcNode.length?srcNode.position('y')+80:300;
        S.cy.add({group:'nodes',data:{id:cn,label:`IF\n${c.cond}`,ntype:'cond'},position:{x:px,y:py}});
        nodeIds.add(cn);
      }
      addE(`Group_${id}`,cn);
      if(dialogue[c.tG]) addE(cn,`Group_${c.tG}`,'TRUE');
      if(dialogue[c.fG]) addE(cn,`Group_${c.fG}`,'FALSE');
    });
  }
  for (const [k,se] of Object.entries(selection)) {
    const id=+k;
    const node=S.cy.getElementById(`SE_${id}`);
    if (node.length) node.data('label',`SE ${id}\n${sePreview(se.rawLines)}`);
    for (const opt of optionsFromSE(se.rawLines))
      if(dialogue[opt.target]) addE(`SE_${id}`,`Group_${opt.target}`,opt.label.substring(0,12));
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  In-Place Node Update (save without layout)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateGroupInCy(gId, lines, dialogue) {
  if(!S.cy) return;
  const node=S.cy.getElementById(`Group_${gId}`); if(!node.length) return;
  const info=edgesFromGroup(lines);
  node.data('label',`Group ${gId}\n${groupPreview(lines)}`);
  node.data('ntype',calcNtype(lines));
  // Remove outgoing edges + old cond children
  S.cy.edges(`[source="Group_${gId}"]`).remove();
  S.cy.nodes().filter(n=>n.id().startsWith(`Cond_${gId}_`)).remove();
  const uid=()=>`eu_${Date.now()}_${Math.random().toString(36).slice(2,6)}`;
  const addE=(src,tgt,lbl='')=>{ if(S.cy.getElementById(tgt).length) S.cy.add({group:'edges',data:{id:uid(),source:src,target:tgt,label:lbl}}); };
  for (const t of info.jumps) if(dialogue[t]) addE(`Group_${gId}`,`Group_${t}`);
  for (const s of info.sels) addE(`Group_${gId}`,`SE_${s}`,'é¸é …');
  info.conds.forEach((c,ci)=>{
    const cn=`Cond_${gId}_${ci}`;
    S.cy.add({group:'nodes',data:{id:cn,label:`IF\n${c.cond}`,ntype:'cond'},position:{x:node.position('x')+100,y:node.position('y')+80}});
    addE(`Group_${gId}`,cn);
    if(dialogue[c.tG]) addE(cn,`Group_${c.tG}`,'TRUE');
    if(dialogue[c.fG]) addE(cn,`Group_${c.fG}`,'FALSE');
  });
}
function updateSEInCy(sId, lines, dialogue) {
  if(!S.cy) return;
  const node=S.cy.getElementById(`SE_${sId}`); if(!node.length) return;
  node.data('label',`SE ${sId}\n${sePreview(lines)}`);
  S.cy.edges(`[source="SE_${sId}"]`).remove();
  const uid=()=>`eu_${Date.now()}_${Math.random().toString(36).slice(2,6)}`;
  for (const opt of optionsFromSE(lines))
    if(S.cy.getElementById(`Group_${opt.target}`).length)
      S.cy.add({group:'edges',data:{id:uid(),source:`SE_${sId}`,target:`Group_${opt.target}`,label:opt.label.substring(0,12)}});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Right Panel â€” Node Editor
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPanel() {
  const pc=document.getElementById('pc'), pa=document.getElementById('pa');
  const id=S.sel;
  if(!id||!S.active||S.active==='flags'||S.active==='extra_flags'){
    pc.innerHTML='<div class="empty-panel">é»é¸ç¯€é»<br>ä»¥æŸ¥çœ‹ä¸¦ç·¨è¼¯å…§å®¹</div>';
    pa.style.display='none'; return;
  }
  const c=S.chapters[S.active];
  let html='';

  if (id.startsWith('Group_')) {
    const gId=+id.replace('Group_','');
    const g=c.dialogue[gId]; if(!g) return;
    const info=edgesFromGroup(g.rawLines);
    const ntype=info.battleId?'âš” æˆ°é¬¥ Group':info.sceneId!==null?'ğŸšª å ´æ™¯è·³è½‰':'ğŸ’¬ å°è©± Group';
    const tc=info.battleId?'tb':'tg';
    html+=`<div class="fl">é¡å‹</div><div class="fv"><span class="tag ${tc}">${ntype}</span></div>`;
    html+=`<div class="fl">Group ID</div><div class="fv">${gId}</div>`;
    html+=`<div class="fl">ç« ç¯€</div><div class="fv">${S.active}</div>`;
    if(info.battleId) html+=`<div class="fl">æˆ°é¬¥ ID</div><div class="fv">${info.battleId}</div>`;
    const links=[...info.jumps.map(j=>`Group_${j}`),...info.sels.map(s=>`SE_${s}`),...info.conds.flatMap(c=>[`Group_${c.tG}`,`Group_${c.fG}`])];
    if(links.length) html+=`<div class="fl">é€£çµ</div><div class="fv" style="font-size:11px;color:#8b949e">${links.join(', ')}</div>`;
    html+=`<div class="fl">å…§å®¹é è¦½ (${g.rawLines.length} è¡Œ)</div>`;
    html+=`<div class="fv preview-box">${esc(g.rawLines.slice(0,6).join('\n'))}${g.rawLines.length>6?'\n...':''}</div>`;
  } else if (id.startsWith('SE_')) {
    const sId=+id.replace('SE_','');
    const se=c.selection[sId]; if(!se) return;
    const opts=optionsFromSE(se.rawLines);
    html+=`<div class="fl">é¡å‹</div><div class="fv"><span class="tag ts">ğŸ”€ é¸é …åˆ†æ”¯</span></div>`;
    html+=`<div class="fl">SE ID</div><div class="fv">${sId}</div>`;
    html+=`<div class="fl">ç« ç¯€</div><div class="fv">${S.active}</div>`;
    if(opts.length){ html+=`<div class="fl">é¸é … (${opts.length})</div>`; opts.forEach(o=>{html+=`<div class="fv" style="font-size:11px;padding:2px 0">â–¸ ${esc(o.label)} â†’ Group_${o.target}</div>`;}); }
    html+=`<div class="fl">å…§å®¹é è¦½ (${se.rawLines.length} è¡Œ)</div>`;
    html+=`<div class="fv preview-box">${esc(se.rawLines.slice(0,6).join('\n'))}${se.rawLines.length>6?'\n...':''}</div>`;
  } else if (id.startsWith('Cond_')) {
    html+=`<div class="fl">é¡å‹</div><div class="fv"><span class="tag tc">ğŸ”® æ¢ä»¶åˆ†æ”¯</span></div>`;
    html+=`<div class="fv" style="font-size:11px;color:#8b949e;line-height:1.8;margin-top:12px">ç”± Group çš„<br><code>{IF_flag:G_true:G_false}</code><br>ç”¢ç”Ÿï¼Œè«‹ç·¨è¼¯å°æ‡‰ Group</div>`;
    pc.innerHTML=html; pa.style.display='none'; return;
  }
  pc.innerHTML=html;
  pa.style.display='flex';
}

function saveEdit() {
  const ed=document.getElementById('node-editor');
  if(!ed||!S.sel||!S.active) return;
  const c=S.chapters[S.active], lines=ed.value.split('\n');
  if (S.sel.startsWith('Group_')) {
    const gId=+S.sel.replace('Group_','');
    if(!c.dialogue[gId]) return;
    c.dialogue[gId].rawLines=lines;
    updateGroupInCy(gId,lines,c.dialogue);
  } else if (S.sel.startsWith('SE_')) {
    const sId=+S.sel.replace('SE_','');
    if(!c.selection[sId]) return;
    c.selection[sId].rawLines=lines;
    updateSEInCy(sId,lines,c.dialogue);
  }
  syncPosCache();   // save updated positions (cond nodes may have moved)
  renderPanel();
  setStatus('å·²å„²å­˜');
}
function deselNode(){ S.sel=null; renderPanel(); if(S.cy) S.cy.elements().unselect(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Add New Nodes (FAB)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function nextGroupId(){ const ids=Object.keys(S.chapters[S.active].dialogue).map(Number); return ids.length?Math.max(...ids)+1:0; }
function nextSEId(){    const ids=Object.keys(S.chapters[S.active].selection).map(Number); return ids.length?Math.max(...ids)+1:0; }
function centerPos(){
  if(!S.cy) return {x:200,y:200};
  const c=S.cy.container(), pan=S.cy.pan(), zoom=S.cy.zoom();
  return {x:(c.offsetWidth/2-pan.x)/zoom, y:(c.offsetHeight/2-pan.y)/zoom};
}

function addNewGroup(){
  if(!S.active||S.active==='flags'||S.active==='extra_flags'){alert('è«‹å…ˆé¸æ“‡ä¸€å€‹ç« ç¯€');return;}
  const id=nextGroupId();
  const template=['ä½ ï¼šï¼ˆ...ï¼‰','{G_???}'];
  S.chapters[S.active].dialogue[id]={id,rawLines:template};
  if(!S.cy){ refreshGraph(); setTimeout(()=>{if(S.cy){S.cy.getElementById(`Group_${id}`).select();S.sel=`Group_${id}`;renderPanel();}},80); }
  else {
    const pos=centerPos();
    S.cy.add({group:'nodes',data:{id:`Group_${id}`,label:`Group ${id}\n${groupPreview(template)}`,ntype:'group'},position:pos});
    S.cy.getElementById(`Group_${id}`).select(); S.sel=`Group_${id}`; renderPanel(); syncPosCache();
  }
  updateBadges(); setStatus(`å·²æ–°å¢ Group_${id}ï¼ˆ${S.active}ï¼‰`);
}
function addNewSE(){
  if(!S.active||S.active==='flags'||S.active==='extra_flags'){alert('è«‹å…ˆé¸æ“‡ä¸€å€‹ç« ç¯€');return;}
  const id=nextSEId();
  const template=['Buttonset_0:é¸é …ä¸€:{G_???}','Buttonset_1:é¸é …äºŒ:{G_???}'];
  S.chapters[S.active].selection[id]={id,rawLines:template};
  if(!S.cy){ refreshGraph(); setTimeout(()=>{if(S.cy){S.cy.getElementById(`SE_${id}`).select();S.sel=`SE_${id}`;renderPanel();}},80); }
  else {
    const pos=centerPos();
    S.cy.add({group:'nodes',data:{id:`SE_${id}`,label:`SE ${id}\n${sePreview(template)}`,ntype:'se'},position:pos});
    S.cy.getElementById(`SE_${id}`).select(); S.sel=`SE_${id}`; renderPanel(); syncPosCache();
  }
  updateBadges(); setStatus(`å·²æ–°å¢ SE_${id}ï¼ˆ${S.active}ï¼‰`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Sidebar Navigation
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setActive(key) {
  // Save positions of current chapter before leaving
  syncPosCache();

  S.active=key; S.sel=null;
  document.querySelectorAll('.sb-item').forEach(el=>el.classList.remove('active'));
  const sbEl=document.getElementById(`sb-${key}`);
  if(sbEl) sbEl.classList.add('active');

  const cyWrap=document.getElementById('cy-wrap');
  const fwrap=document.getElementById('flags-wrap');
  const fab=document.getElementById('fab');
  const isFlags=(key==='flags'||key==='extra_flags');

  if(isFlags){
    cyWrap.style.display='none'; fwrap.classList.add('visible'); fab.classList.add('hidden');
    if(S.cy){S.cy.destroy();S.cy=null;}
    renderFlagsPanel(key); renderPanel();
  } else {
    cyWrap.style.display=''; fwrap.classList.remove('visible'); fab.classList.remove('hidden');
    refreshGraph();   // uses posCache if available, otherwise runs layout
    // Refresh edges to reflect latest data (handles re-entry after edits)
    if (S.cy) refreshEdgesOnly();
    renderPanel();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Flags Editor
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderFlagsPanel(key){
  const wrap=document.getElementById('flags-wrap');
  const flags=key==='flags'?S.globalFlags:S.extraFlags;
  const label=key==='flags'?'å…¨åŸŸæ——æ¨™  (GlobalFlags.txt)':'æ”¯ç·šæ——æ¨™  (Extra_Flags.txt)';
  let html=`<div class="flags-title">ğŸ³ ${label}</div>`;
  html+=`<table class="flags-table"><thead><tr><th>æ——æ¨™åç¨±</th><th>åˆå§‹å€¼</th><th></th></tr></thead><tbody>`;
  flags.forEach((f,i)=>{
    html+=`<tr><td><input class="flag-name" value="${esc(f.name)}" onchange="updateFlag('${key}',${i},'name',this.value)"></td><td><input class="flag-val" value="${esc(f.value)}" onchange="updateFlag('${key}',${i},'value',this.value)"></td><td><button class="flag-del" onclick="deleteFlag('${key}',${i})">âœ•</button></td></tr>`;
  });
  html+=`</tbody></table><div class="flags-add"><input class="fadd-input" id="fn-name" placeholder="æ——æ¨™åç¨±" style="width:220px"><input class="fadd-input" id="fn-val" placeholder="åˆå§‹å€¼" style="width:80px"><button class="btn btn-secondary" onclick="addFlag('${key}')">ï¼‹ æ–°å¢</button></div>`;
  wrap.innerHTML=html;
}
function updateFlag(key,idx,field,val){ (key==='flags'?S.globalFlags:S.extraFlags)[idx][field]=val; }
function deleteFlag(key,idx){ (key==='flags'?S.globalFlags:S.extraFlags).splice(idx,1); renderFlagsPanel(key); }
function addFlag(key){
  const name=document.getElementById('fn-name').value.trim();
  const val=document.getElementById('fn-val').value.trim()||'0';
  if(!name){document.getElementById('fn-name').focus();return;}
  (key==='flags'?S.globalFlags:S.extraFlags).push({name,value:val}); renderFlagsPanel(key);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Import â€” Master
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function triggerImportMaster(){document.getElementById('fi-master').click();}
function onImportMaster(e){
  const f=e.target.files[0];if(!f)return;
  S.masterFile=f.name;
  const r=new FileReader();
  r.onload=ev=>{
    S.posCache={};  // clear position cache on full import
    parseMasterFile(ev.target.result);
    updateBadges(); setStatus(`å·²è¼‰å…¥ä¸»æª”ï¼š${f.name}`);
    const firstKey=[...CH_KEYS,'Extra'].find(k=>{ const c=S.chapters[k]; return Object.keys(c.dialogue).length||Object.keys(c.selection).length; });
    if(firstKey) setActive(firstKey);
    else if(S.globalFlags.length) setActive('flags');
  };
  r.readAsText(f,'UTF-8'); e.target.value='';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Import â€” Individual
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const IND_INPUT={d:'fi-d',s:'fi-s',ed:'fi-ed',es:'fi-es',gf:'fi-gf',ef:'fi-ef'};
function trigInd(t){document.getElementById(IND_INPUT[t]).click();}
function onInd(type,e){
  const f=e.target.files[0];if(!f)return;
  const r=new FileReader();
  r.onload=ev=>{
    const txt=ev.target.result;
    const tKey=S.active&&S.active!=='flags'&&S.active!=='extra_flags'?S.active:'Chapter_0';
    if(type==='d'){S.chapters[tKey].dialogue=parseDialogue(txt);delete S.posCache[tKey];setStatus(`Dialogue â†’ ${tKey}`);updateBadges();if(S.active===tKey)refreshGraph();}
    else if(type==='s'){S.chapters[tKey].selection=parseSelection(txt);setStatus(`Selection â†’ ${tKey}`);updateBadges();if(S.active===tKey&&S.cy)refreshEdgesOnly();}
    else if(type==='ed'){S.chapters['Extra'].dialogue=parseDialogue(txt);delete S.posCache['Extra'];setStatus('Extra_Dialogue å·²è¼‰å…¥');updateBadges();if(S.active==='Extra')refreshGraph();}
    else if(type==='es'){S.chapters['Extra'].selection=parseSelection(txt);setStatus('Extra_Selection å·²è¼‰å…¥');updateBadges();if(S.active==='Extra'&&S.cy)refreshEdgesOnly();}
    else if(type==='gf'){S.globalFlags=parseFlags(txt);setStatus('GlobalFlags å·²è¼‰å…¥');if(S.active==='flags')renderFlagsPanel('flags');}
    else if(type==='ef'){S.extraFlags=parseFlags(txt);setStatus('Extra_Flags å·²è¼‰å…¥');if(S.active==='extra_flags')renderFlagsPanel('extra_flags');}
  };
  r.readAsText(f,'UTF-8'); e.target.value='';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Export
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function doSaveMaster(){ download(generateMasterFile(),S.masterFile); setStatus('ä¸»æª”å·²ä¸‹è¼‰ï¼š'+S.masterFile); }
async function doRelease(){
  if(typeof JSZip==='undefined'){alert('JSZip å°šæœªè¼‰å…¥ï¼Œè«‹ç¢ºèªç¶²è·¯é€£ç·š');return;}
  const zip=new JSZip();
  if(S.globalFlags.length) zip.file('Flags/GlobalFlags.txt',genFlags(S.globalFlags));
  CH_KEYS.forEach(key=>{
    const c=S.chapters[key];
    if(Object.keys(c.dialogue).length)  zip.file(`MainStory/${key}/${key}_Dialogue.txt`,genDialogue(c.dialogue));
    if(Object.keys(c.selection).length) zip.file(`MainStory/${key}/${key}_Selection.txt`,genSelection(c.selection));
  });
  const ex=S.chapters['Extra'];
  if(Object.keys(ex.dialogue).length)  zip.file('Extra/Extra_Dialogue.txt',genDialogue(ex.dialogue));
  if(Object.keys(ex.selection).length) zip.file('Extra/Extra_Selection.txt',genSelection(ex.selection));
  if(S.extraFlags.length)              zip.file('Extra/Extra_Flags.txt',genFlags(S.extraFlags));
  const blob=await zip.generateAsync({type:'blob'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='release.zip'; a.click();
  setStatus('release.zip å·²ä¸‹è¼‰');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Rubber Band Multi-Select (right-click drag)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initRubberBand(){
  const wrap=document.getElementById('cy-wrap');
  const rb=document.getElementById('rubberband');
  let active=false, startX=0, startY=0, hasMoved=false;

  // Block context menu on the canvas area
  wrap.addEventListener('contextmenu', e=>{ e.preventDefault(); });

  wrap.addEventListener('mousedown', e=>{
    if(e.button!==2) return;
    if(!S.cy) return;
    e.preventDefault();
    const rect=wrap.getBoundingClientRect();
    startX=e.clientX-rect.left;
    startY=e.clientY-rect.top;
    active=true; hasMoved=false;
    rb.style.left=startX+'px'; rb.style.top=startY+'px';
    rb.style.width='0'; rb.style.height='0'; rb.style.display='none';
  });

  document.addEventListener('mousemove', e=>{
    if(!active||!S.cy) return;
    const rect=wrap.getBoundingClientRect();
    const cx=e.clientX-rect.left, cy=e.clientY-rect.top;
    const dx=Math.abs(cx-startX), dy=Math.abs(cy-startY);
    if(dx>4||dy>4){ hasMoved=true; }
    if(hasMoved){
      rb.style.display='block';
      rb.style.left  =Math.min(startX,cx)+'px';
      rb.style.top   =Math.min(startY,cy)+'px';
      rb.style.width =Math.abs(cx-startX)+'px';
      rb.style.height=Math.abs(cy-startY)+'px';
    }
  });

  document.addEventListener('mouseup', e=>{
    if(!active||e.button!==2) return;
    active=false; rb.style.display='none';

    if(!S.cy){ return; }

    if(!hasMoved){
      // plain right-click â†’ deselect all
      S.cy.elements().unselect(); S.sel=null; renderPanel(); return;
    }

    // Convert rubber band screen coords â†’ cytoscape model coords
    const rect=wrap.getBoundingClientRect();
    const ex=e.clientX-rect.left, ey=e.clientY-rect.top;
    const x1=Math.min(startX,ex), y1=Math.min(startY,ey);
    const x2=Math.max(startX,ex), y2=Math.max(startY,ey);
    const pan=S.cy.pan(), zoom=S.cy.zoom();
    const toModel=(sx,sy)=>({x:(sx-pan.x)/zoom, y:(sy-pan.y)/zoom});
    const tl=toModel(x1,y1), br=toModel(x2,y2);

    S.cy.elements().unselect();
    S.cy.nodes().forEach(node=>{
      const p=node.position();
      if(p.x>=tl.x&&p.x<=br.x&&p.y>=tl.y&&p.y<=br.y) node.select();
    });
    // Only show editor if exactly one node selected
    const sel=S.cy.nodes(':selected');
    S.sel = sel.length===1 ? sel[0].id() : null;
    renderPanel();
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Panel Resize
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initPanelResize(){
  const handle=document.getElementById('panel-resize');
  const panel=document.getElementById('panel');
  let dragging=false, startX=0, startW=0;
  handle.addEventListener('mousedown',e=>{
    dragging=true; startX=e.clientX; startW=panel.offsetWidth;
    handle.classList.add('dragging');
    document.body.style.cursor='col-resize'; document.body.style.userSelect='none';
    e.preventDefault();
  });
  document.addEventListener('mousemove',e=>{
    if(!dragging)return;
    panel.style.width=Math.max(200,Math.min(680,startW+(startX-e.clientX)))+'px';
  });
  document.addEventListener('mouseup',()=>{
    if(!dragging)return; dragging=false;
    handle.classList.remove('dragging');
    document.body.style.cursor=''; document.body.style.userSelect='';
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Modal Editor
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let modalFontSize = 14;

function openModal() {
  if (!S.sel || !S.active || S.active==='flags' || S.active==='extra_flags') return;
  const c = S.chapters[S.active];
  const overlay = document.getElementById('modal-overlay');
  const titleEl = document.getElementById('modal-title');
  const infoEl = document.getElementById('modal-info');
  const editor = document.getElementById('modal-editor');
  const highlight = document.getElementById('editor-highlight');

  let content = '', title = '', info = '';

  if (S.sel.startsWith('Group_')) {
    const gId = +S.sel.replace('Group_','');
    const g = c.dialogue[gId]; if (!g) return;
    content = g.rawLines.join('\n');
    const ei = edgesFromGroup(g.rawLines);
    const ntype = ei.battleId ? 'âš” æˆ°é¬¥' : ei.sceneId!==null ? 'ğŸšª å ´æ™¯è·³è½‰' : 'ğŸ’¬ å°è©±';
    title = `ç·¨è¼¯ Group_${gId}`;
    info = `<span class="tag ${ei.battleId?'tb':'tg'}">${ntype}</span> ${S.active}`;
  } else if (S.sel.startsWith('SE_')) {
    const sId = +S.sel.replace('SE_','');
    const se = c.selection[sId]; if (!se) return;
    content = se.rawLines.join('\n');
    title = `ç·¨è¼¯ SE_${sId}`;
    info = `<span class="tag ts">ğŸ”€ é¸é …åˆ†æ”¯</span> ${S.active}`;
  } else {
    return;
  }

  titleEl.textContent = title;
  infoEl.innerHTML = info;
  editor.value = content;
  editor.style.fontSize = modalFontSize + 'px';
  highlight.style.fontSize = modalFontSize + 'px';
  syncHighlight();

  overlay.classList.add('open');
  // Reset modal position to center
  const box = document.getElementById('modal-box');
  box.style.transform = '';
  box.style.left = '';
  box.style.top = '';

  setTimeout(() => editor.focus(), 50);
}

function closeModal() {
  document.getElementById('modal-overlay').classList.remove('open');
}

function onOverlayClick(e) {
  if (e.target.id === 'modal-overlay') closeModal();
}

function saveModal() {
  const editor = document.getElementById('modal-editor');
  if (!editor || !S.sel || !S.active) return;
  const c = S.chapters[S.active];
  const lines = editor.value.split('\n');

  if (S.sel.startsWith('Group_')) {
    const gId = +S.sel.replace('Group_','');
    if (!c.dialogue[gId]) return;
    c.dialogue[gId].rawLines = lines;
    updateGroupInCy(gId, lines, c.dialogue);
  } else if (S.sel.startsWith('SE_')) {
    const sId = +S.sel.replace('SE_','');
    if (!c.selection[sId]) return;
    c.selection[sId].rawLines = lines;
    updateSEInCy(sId, lines, c.dialogue);
  }

  syncPosCache();
  renderPanel();
  closeModal();
  setStatus('å·²å„²å­˜');
}

function syncHighlight() {
  const editor = document.getElementById('modal-editor');
  const highlight = document.getElementById('editor-highlight');
  const text = editor.value;

  // Build highlighted HTML
  const lines = text.split('\n');
  const htmlLines = lines.map(line => {
    // Check if line is a comment (starts with //)
    const trimmed = line.trim();
    if (trimmed.startsWith('//')) {
      return `<span class="hl-comment">${escHtml(line)}</span>`;
    }
    // Highlight {} commands
    let result = '';
    let lastIdx = 0;
    const regex = /\{[^}]+\}/g;
    let match;
    while ((match = regex.exec(line)) !== null) {
      if (match.index > lastIdx) {
        result += `<span class="hl-text">${escHtml(line.slice(lastIdx, match.index))}</span>`;
      }
      result += `<span class="hl-cmd">${escHtml(match[0])}</span>`;
      lastIdx = regex.lastIndex;
    }
    if (lastIdx < line.length) {
      result += `<span class="hl-text">${escHtml(line.slice(lastIdx))}</span>`;
    }
    return result || `<span class="hl-text">${escHtml(line) || ' '}</span>`;
  });

  highlight.innerHTML = htmlLines.join('\n') + '\n';
  syncScroll();
}

function syncScroll() {
  const editor = document.getElementById('modal-editor');
  const highlight = document.getElementById('editor-highlight');
  highlight.scrollTop = editor.scrollTop;
  highlight.scrollLeft = editor.scrollLeft;
}

function setCmdMode(mode) {
  const wrap = document.getElementById('editor-wrap');
  wrap.classList.remove('cmd-dim', 'cmd-hide');
  if (mode === 'dim') wrap.classList.add('cmd-dim');
  else if (mode === 'hide') wrap.classList.add('cmd-hide');
  // Update button states
  document.querySelectorAll('.cmd-btn').forEach(btn => btn.classList.remove('active'));
  const btnMap = { normal: 0, dim: 1, hide: 2 };
  document.querySelectorAll('.cmd-btn')[btnMap[mode]]?.classList.add('active');
}

function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// Modal drag (header)
function initModalDrag() {
  const header = document.getElementById('modal-header');
  const box = document.getElementById('modal-box');
  let dragging = false, startX = 0, startY = 0, origX = 0, origY = 0;

  header.addEventListener('mousedown', e => {
    if (e.target.id === 'modal-close') return;
    dragging = true;
    startX = e.clientX;
    startY = e.clientY;
    const rect = box.getBoundingClientRect();
    origX = rect.left;
    origY = rect.top;
    e.preventDefault();
  });

  document.addEventListener('mousemove', e => {
    if (!dragging) return;
    const dx = e.clientX - startX;
    const dy = e.clientY - startY;
    box.style.position = 'fixed';
    box.style.left = (origX + dx) + 'px';
    box.style.top = (origY + dy) + 'px';
    box.style.transform = 'none';
  });

  document.addEventListener('mouseup', () => { dragging = false; });
}

// Modal resize (corner)
function initModalResize() {
  const handle = document.getElementById('modal-resize');
  const box = document.getElementById('modal-box');
  let resizing = false, startX = 0, startY = 0, startW = 0, startH = 0;

  handle.addEventListener('mousedown', e => {
    resizing = true;
    startX = e.clientX;
    startY = e.clientY;
    startW = box.offsetWidth;
    startH = box.offsetHeight;
    e.preventDefault();
    e.stopPropagation();
  });

  document.addEventListener('mousemove', e => {
    if (!resizing) return;
    const w = Math.max(400, startW + (e.clientX - startX));
    const h = Math.max(300, startH + (e.clientY - startY));
    box.style.width = w + 'px';
    box.style.height = h + 'px';
  });

  document.addEventListener('mouseup', () => { resizing = false; });
}

// Ctrl + wheel to zoom font
function initModalZoom() {
  const wrap = document.getElementById('editor-wrap');
  wrap.addEventListener('wheel', e => {
    if (!e.ctrlKey) return;
    e.preventDefault();
    const delta = e.deltaY > 0 ? -1 : 1;
    modalFontSize = Math.max(10, Math.min(24, modalFontSize + delta));
    const editor = document.getElementById('modal-editor');
    const highlight = document.getElementById('editor-highlight');
    editor.style.fontSize = modalFontSize + 'px';
    highlight.style.fontSize = modalFontSize + 'px';
  }, { passive: false });
}

// ESC to close modal
document.addEventListener('keydown', e => {
  if (e.key === 'Escape' && document.getElementById('modal-overlay').classList.contains('open')) {
    closeModal();
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Cloud Storage (jsonbin.io)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CLOUD_STORAGE_KEY = 'ayan_editor_apikey';
const CLOUD_BINS_KEY = 'ayan_editor_bins';

function getApiKey() {
  return localStorage.getItem(CLOUD_STORAGE_KEY) || '';
}
function setApiKey(key) {
  localStorage.setItem(CLOUD_STORAGE_KEY, key);
}
function getBinsMap() {
  try { return JSON.parse(localStorage.getItem(CLOUD_BINS_KEY) || '{}'); }
  catch { return {}; }
}
function setBinsMap(map) {
  localStorage.setItem(CLOUD_BINS_KEY, JSON.stringify(map));
}

function showCloudSettings() {
  const current = getApiKey();
  const masked = current ? current.substring(0, 20) + '...' : 'ï¼ˆå°šæœªè¨­å®šï¼‰';
  const newKey = prompt(`ç›®å‰ API Keyï¼š${masked}\n\nè«‹è¼¸å…¥ jsonbin.io çš„ X-Master-Keyï¼š\nï¼ˆå‰å¾€ jsonbin.io è¨»å†Šå¾Œï¼Œåœ¨ API Keys é é¢å–å¾—ï¼‰`, current);
  if (newKey !== null && newKey.trim()) {
    setApiKey(newKey.trim());
    setStatus('API Key å·²å„²å­˜');
  }
}

async function cloudSave() {
  const apiKey = getApiKey();
  if (!apiKey) {
    alert('è«‹å…ˆè¨­å®š API Keyï¼\n\né»æ“Šã€Œâ˜ é›²ç«¯ â†’ è¨­å®š API Keyã€');
    return;
  }

  const projectKey = prompt('è«‹è¼¸å…¥å°ˆæ¡ˆä»£ç¢¼ï¼ˆç”¨æ–¼è­˜åˆ¥é€™å€‹å°ˆæ¡ˆï¼Œä¾‹å¦‚ï¼štianmo_v1ï¼‰ï¼š');
  if (!projectKey || !projectKey.trim()) return;
  const key = projectKey.trim().toLowerCase();

  setStatus('â˜ æ­£åœ¨å„²å­˜åˆ°é›²ç«¯...');

  const data = {
    masterContent: generateMasterFile(),
    posCache: S.posCache,
    savedAt: new Date().toISOString()
  };

  const binsMap = getBinsMap();
  const existingBinId = binsMap[key];

  try {
    let response;
    if (existingBinId) {
      // Update existing bin
      response = await fetch(`https://api.jsonbin.io/v3/b/${existingBinId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'X-Master-Key': apiKey
        },
        body: JSON.stringify(data)
      });
    } else {
      // Create new bin
      response = await fetch('https://api.jsonbin.io/v3/b', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Master-Key': apiKey,
          'X-Bin-Name': `ayan_editor_${key}`
        },
        body: JSON.stringify(data)
      });
    }

    if (!response.ok) {
      const err = await response.json();
      throw new Error(err.message || 'å„²å­˜å¤±æ•—');
    }

    const result = await response.json();
    if (!existingBinId && result.metadata?.id) {
      binsMap[key] = result.metadata.id;
      setBinsMap(binsMap);
    }

    setStatus(`â˜ å·²å„²å­˜åˆ°é›²ç«¯ [${key}]`);
    alert(`é›²ç«¯å­˜æª”æˆåŠŸï¼\n\nå°ˆæ¡ˆä»£ç¢¼ï¼š${key}\n\nä¸‹æ¬¡åœ¨ä»»ä½•è£ç½®è¼¸å…¥ç›¸åŒçš„ API Key å’Œå°ˆæ¡ˆä»£ç¢¼å³å¯è®€å–ã€‚`);
  } catch (err) {
    setStatus('â˜ å„²å­˜å¤±æ•—');
    alert('é›²ç«¯å„²å­˜å¤±æ•—ï¼š' + err.message);
  }
}

async function cloudLoad() {
  const apiKey = getApiKey();
  if (!apiKey) {
    alert('è«‹å…ˆè¨­å®š API Keyï¼\n\né»æ“Šã€Œâ˜ é›²ç«¯ â†’ è¨­å®š API Keyã€');
    return;
  }

  const projectKey = prompt('è«‹è¼¸å…¥è¦è®€å–çš„å°ˆæ¡ˆä»£ç¢¼ï¼š');
  if (!projectKey || !projectKey.trim()) return;
  const key = projectKey.trim().toLowerCase();

  const binsMap = getBinsMap();
  let binId = binsMap[key];

  // If not in local cache, try to find by searching (requires bin ID input)
  if (!binId) {
    const manualId = prompt(`æ‰¾ä¸åˆ°å°ˆæ¡ˆ [${key}] çš„æœ¬åœ°è¨˜éŒ„ã€‚\n\nå¦‚æœä½ åœ¨å…¶ä»–è£ç½®å„²å­˜éï¼Œè«‹è¼¸å…¥ Bin IDï¼š\nï¼ˆå¯åœ¨ jsonbin.io çš„ Bins é é¢æ‰¾åˆ°ï¼‰\n\næˆ–æŒ‰å–æ¶ˆæ”¾æ£„ã€‚`);
    if (!manualId || !manualId.trim()) return;
    binId = manualId.trim();
  }

  setStatus('â˜ æ­£åœ¨å¾é›²ç«¯è®€å–...');

  try {
    const response = await fetch(`https://api.jsonbin.io/v3/b/${binId}/latest`, {
      headers: { 'X-Master-Key': apiKey }
    });

    if (!response.ok) {
      const err = await response.json();
      throw new Error(err.message || 'è®€å–å¤±æ•—');
    }

    const result = await response.json();
    const data = result.record;

    if (!data.masterContent) {
      throw new Error('è³‡æ–™æ ¼å¼ä¸æ­£ç¢º');
    }

    // Save bin ID to local cache
    binsMap[key] = binId;
    setBinsMap(binsMap);

    // Load data
    S.posCache = data.posCache || {};
    parseMasterFile(data.masterContent);
    updateBadges();

    const savedAt = data.savedAt ? new Date(data.savedAt).toLocaleString() : 'æœªçŸ¥';
    setStatus(`â˜ å·²å¾é›²ç«¯è¼‰å…¥ [${key}]`);

    // Switch to first chapter with content
    const firstKey = [...CH_KEYS, 'Extra'].find(k => {
      const c = S.chapters[k];
      return Object.keys(c.dialogue).length || Object.keys(c.selection).length;
    });
    if (firstKey) setActive(firstKey);
    else if (S.globalFlags.length) setActive('flags');

    alert(`é›²ç«¯è®€å–æˆåŠŸï¼\n\nå°ˆæ¡ˆä»£ç¢¼ï¼š${key}\nå„²å­˜æ™‚é–“ï¼š${savedAt}`);
  } catch (err) {
    setStatus('â˜ è®€å–å¤±æ•—');
    alert('é›²ç«¯è®€å–å¤±æ•—ï¼š' + err.message);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Helpers
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function numSort(dict){ return Object.keys(dict).map(Number).sort((a,b)=>a-b); }
function download(content,filename){
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([content],{type:'text/plain;charset=utf-8'}));
  a.download=filename; a.click();
}
function updateBadges(){
  [...CH_KEYS,'Extra'].forEach(k=>{
    const el=document.getElementById(`badge-${k}`); if(!el)return;
    const cnt=Object.keys(S.chapters[k].dialogue).length;
    el.textContent=cnt?` ${cnt}`:'';
  });
}
function setStatus(msg){ document.getElementById('status').textContent=msg||'å°±ç·’'; }
function esc(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function toggleDD(id){ document.getElementById(id+'-menu').classList.toggle('open'); }
function closeDD(id){ document.getElementById(id+'-menu').classList.remove('open'); }
document.addEventListener('click',e=>{
  document.querySelectorAll('.dropdown-menu.open').forEach(m=>{
    if(!m.closest('.dropdown').contains(e.target)) m.classList.remove('open');
  });
});

// â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
initPanelResize();
initRubberBand();
initModalDrag();
initModalResize();
initModalZoom();
</script>
</body>
</html>
